<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Turnstile 验证系统</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit&onload=onLoadCallback" async defer></script>
    <style>
        /* 样式保持不变（省略重复部分） */
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header">
            <h1>安全验证</h1>
            <p class="subtitle">请完成人机验证以继续</p>
        </div>
        
        <div class="card-body">
            <div class="status-container">
                <div id="verification-widget">
                    <div id="turnstile-container"></div>
                </div>
                
                <div id="result-message" class="result-message"></div>
            </div>
            
            <button id="reset-button" class="action-button hidden">重新验证</button>
        </div>
        
        <div class="footer">
            <p>此验证系统保护您的访问安全</p>
            <div class="powered-by">
                <svg class="cf-logo" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8.00039 0L12.8004 4.8L11.2004 6.4L8.00039 3.2L4.80039 6.4L3.20039 4.8L8.00039 0ZM4.80039 9.6L3.20039 11.2L8.00039 16L12.8004 11.2L11.2004 9.6L8.00039 12.8L4.80039 9.6Z"/>
                </svg>
                <span>Powered by Cloudflare Turnstile</span>
            </div>
        </div>
    </div>

    <script>
        // 配置参数 - 使用您提供的密钥
        const CONFIG = {
            siteKey: "0x4AAAAAABimt1T7asd60UgX",  // 您的站点密钥
            verifyEndpoint: "https://rjyz.myproject.dpdns.org/" // 验证端点
        };

        // DOM元素
        const turnstileContainer = document.getElementById('turnstile-container');
        const resultMessage = document.getElementById('result-message');
        const resetButton = document.getElementById('reset-button');
        let turnstileWidget;

        // 显式渲染Turnstile组件
        function renderTurnstile() {
            turnstileContainer.innerHTML = "";
            resultMessage.classList.remove('show');
            resetButton.classList.add('hidden');
            
            turnstileWidget = window.turnstile.render('#turnstile-container', {
                sitekey: CONFIG.siteKey,
                theme: "light",
                size: "normal",
                retry: "auto",
                language: "zh",
                callback: function(token) {
                    handleVerification(token);
                },
                'expired-callback': function() {
                    showResult("<div class='icon'>⏳</div><div>验证已过期，请重新验证</div>", "error");
                    resetButton.classList.remove('hidden');
                },
                'error-callback': function() {
                    showResult("<div class='icon'>⚠️</div><div>验证失败，请重试</div>", "error");
                    resetButton.classList.remove('hidden');
                }
            });
        }

        // 验证结果处理器 - 修复点
        async function handleVerification(token) {
            showResult("<div class='loading'></div><div>正在验证您的身份，请稍候...</div>", "loading");
            
            try {
                const response = await fetch(CONFIG.verifyEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: token })
                });
                
                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // ======= 修复点1: 显示成功消息 =======
                    showResult("<div class='icon'>✅</div><div>验证成功！您是真实用户</div>", "success");
                    
                    // ======= 修复点2: 添加成功后的操作 =======
                    // 3秒后自动隐藏验证组件
                    setTimeout(() => {
                        document.getElementById('verification-widget').style.display = 'none';
                        
                        // 显示后续内容（例如：显示被保护的内容）
                        resultMessage.innerHTML += '<div style="margin-top:20px;font-size:16px;">正在为您加载受保护的内容...</div>';
                        
                        // 实际应用中这里可以跳转或显示隐藏内容
                        // window.location.href = "/protected-page";
                    }, 3000);
                    
                } else {
                    showResult(`<div class='icon'>❌</div><div>验证失败：${result.message || '疑似机器人行为'}</div>`, "error");
                    resetButton.classList.remove('hidden');
                }
            } catch (error) {
                // ======= 修复点3: 增强错误处理 =======
                let errorMsg = error.message;
                if (error.message.includes("Failed to fetch")) {
                    errorMsg = "无法连接验证服务器，请检查网络或联系管理员";
                }
                showResult(`<div class='icon'>⚠️</div><div>${errorMsg}</div>`, "error");
                resetButton.classList.remove('hidden');
            }
        }

        // 显示验证结果
        function showResult(html, type) {
            resultMessage.innerHTML = html;
            resultMessage.className = `result-message ${type}`;
            setTimeout(() => resultMessage.classList.add('show'), 10);
        }

        // 重置验证
        resetButton.addEventListener('click', function() {
            // ======= 修复点4: 重置时显示验证组件 =======
            document.getElementById('verification-widget').style.display = 'block';
            renderTurnstile();
        });

        // Turnstile加载完成回调
        window.onLoadCallback = function() {
            renderTurnstile();
        };
    </script>
</body>
</html>
